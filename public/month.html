<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æœˆæ¬¡ä¸€è¦§ï½œç”Ÿæ´»è¡Œå‹•è¡¨</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
        --cell-h: 14px;
        --grid-gap: 2px;
        --cell-radius: 2px;
        --cell-border: 0;
      }
      body {
        padding: 8px;
      }
      .head {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .head h2 {
        margin: 6px 0;
      }
      .legend {
        font-size: 12px;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
        margin-left: auto;
      }
      .legend div {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .box {
        width: 10px;
        height: 10px;
        border: 1px solid #333;
      }
      .monthwrap {
        margin-top: 8px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
      }
      .dayrow {
        display: grid;
        /* æŒ‡æ¨™è¡¨ç¤ºã®ãŸã‚ãƒ©ãƒ™ãƒ«å¹…ã‚’æ‹¡å¼µï¼ˆå°åˆ·æœ€é©åŒ–ã¯åˆ¥Issue #56ã§å¯¾å¿œï¼‰ */
        grid-template-columns: 150px auto;
        gap: 6px;
        align-items: center;
      }
      .daylabel {
        display: flex;
        align-items: center;
        gap: 6px;
        height: var(--cell-h);
        line-height: var(--cell-h);
        overflow: hidden;
      }
      .daylabel .date {
        font-weight: 600;
        font-size: 12px;
        color: #444;
      }
      .daylabel .metrics {
        font-size: 10px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .grid48 {
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        gap: var(--grid-gap);
      }
      .cell {
        height: var(--cell-h);
        border: var(--cell-border);
        border-radius: var(--cell-radius);
      }
      .muted {
        color: #666;
        font-size: 12px;
      }
      @media print {
        body {
          padding: 0;
        }
        .noprint {
          display: none;
        }
        .legend,
        .dayrow {
          break-inside: avoid;
          page-break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <div class="head">
      <h2 id="mtitle">æœˆæ¬¡ä¸€è¦§</h2>
      <div class="legend" id="legend"></div>
      <label class="noprint" style="display: flex; align-items: center; gap: 6px">
        ã‚µãƒ³ãƒ—ãƒ«
        <select id="selSample">
          <option value="0">å®Ÿãƒ‡ãƒ¼ã‚¿</option>
          <option value="1">ã‚µãƒ³ãƒ—ãƒ«1: æ¨™æº–å‹¤å‹™æ—¥</option>
          <option value="2">ã‚µãƒ³ãƒ—ãƒ«2: å¤œå‹¤æ—¥</option>
          <option value="3">ã‚µãƒ³ãƒ—ãƒ«3: å­¦ç¿’é›†ä¸­æ—¥</option>
          <option value="4">ã‚µãƒ³ãƒ—ãƒ«4: æ—…è¡Œæ—¥</option>
          <option value="5">ã‚µãƒ³ãƒ—ãƒ«5: å®¶æ—ãƒ»ã‚±ã‚¢æ—¥</option>
          <option value="6">ã‚µãƒ³ãƒ—ãƒ«6: å›å¾©ï¼ˆä¼‘é¤Šï¼‰æ—¥</option>
        </select>
      </label>
      <label class="noprint" style="display: flex; align-items: center; gap: 6px">
        é…è‰²
        <select id="selPalette">
          <option value="hc">é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ</option>
          <option value="mid" selected>ãƒŸãƒ‰ãƒ«ï¼ˆæ¨™æº–ï¼‰</option>
          <option value="pastel">æ·¡è‰²ï¼ˆæ—§é…è‰²ï¼‰</option>
        </select>
      </label>
      <label class="noprint" style="display: flex; align-items: center; gap: 6px">
        é«˜ã•
        <select id="selHeight">
          <option value="10">10pxï¼ˆå¯†ï¼‰</option>
          <option value="14" selected>14pxï¼ˆæ¨™æº–ï¼‰</option>
          <option value="18">18pxï¼ˆåºƒï¼‰</option>
          <option value="22">22pxï¼ˆç‰¹å¤§ï¼‰</option>
        </select>
      </label>
      <button class="noprint" id="btnPrint">å°åˆ·</button>
    </div>
    <div class="muted" id="subtitle">
      å„è¡Œ: 30åˆ†Ã—24æ™‚é–“ã®æ¦‚æ³ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã€‚ã‚¯ãƒªãƒƒã‚¯ã§æ—¥æ¬¡ãƒšãƒ¼ã‚¸ã¸ã€‚
    </div>
    <div class="monthwrap" id="monthwrap"></div>
    <script>
      (async function () {
        const q = new URLSearchParams(location.search);
        const m = q.get('month') || new Date().toISOString().slice(0, 7);
        const sampleId = parseInt(q.get('sample') || '0', 10) || 0;
        const palQ = (q.get('pal') || '').toLowerCase();
        const storedPal = localStorage.getItem('dailylog.pal') || '';
        const palette = ['hc', 'mid', 'pastel'].includes(palQ)
          ? palQ
          : ['hc', 'mid', 'pastel'].includes(storedPal)
            ? storedPal
            : 'mid';
        document.body.classList.toggle('palette-hc', palette === 'hc');
        document.body.classList.toggle('palette-mid', palette === 'mid');
        document.body.classList.toggle('palette-pastel', palette === 'pastel');
        const hParam = parseInt(q.get('h') || '', 10);
        const storedH = parseInt(localStorage.getItem('dailylog.cell_h') || '', 10);
        const hPick = !Number.isNaN(hParam) ? hParam : !Number.isNaN(storedH) ? storedH : 14;
        if (hPick >= 8 && hPick <= 28) {
          document.documentElement.style.setProperty('--cell-h', hPick + 'px');
        }
        const useSample = sampleId > 0;
        document.getElementById('mtitle').textContent = `æœˆæ¬¡ä¸€è¦§ ${m}`;
        const CATS = [
          ['sleep', 'ç¡çœ '],
          ['work', 'ä»•äº‹'],
          ['study', 'å‹‰å¼·'],
          ['move', 'ç§»å‹•'],
          ['meal', 'é£Ÿäº‹'],
          ['exercise', 'é‹å‹•'],
          ['house', 'å®¶äº‹'],
          ['family', 'å®¶æ—ãƒ»ã‚±ã‚¢'],
          ['rest', 'ä¼‘æ†©'],
          ['other', 'ãã®ä»–'],
        ];
        const lg = document.getElementById('legend');
        for (const [v, lab] of CATS) {
          const dv = document.createElement('div');
          const bx = document.createElement('span');
          bx.className = 'box cat-' + v;
          dv.appendChild(bx);
          const sp = document.createElement('span');
          sp.textContent = lab;
          dv.appendChild(sp);
          lg.appendChild(dv);
        }

        function daysInMonth(ym) {
          const [Y, MM] = ym.split('-').map(Number);
          const last = new Date(Y, MM, 0).getDate();
          const out = [];
          for (let d = 1; d <= last; d++) {
            out.push(`${ym}-${String(d).padStart(2, '0')}`);
          }
          return out;
        }
        function range(a, b) {
          const out = [];
          for (let i = a; i < b; i++) out.push(i);
          return out;
        }
        const slot = (h, m) => h * 2 + (m >= 30 ? 1 : 0);
        function samplePlanForDay(d, sample) {
          const acts = [];
          const push = (start, end, cat, label) => {
            for (let i = start; i < end; i++) {
              acts.push({ slot: i, label, category: cat });
            }
          };
          const PB = (h1, m1, h2, m2, cat, label) => push(slot(h1, m1), slot(h2, m2), cat, label);
          switch (sample) {
            case 1: // æ¨™æº–å‹¤å‹™æ—¥
              PB(0, 0, 6, 30, 'sleep', 'ç¡çœ ');
              PB(6, 30, 7, 30, 'house', 'å®¶äº‹');
              PB(7, 30, 9, 0, 'move', 'ç§»å‹•');
              PB(9, 0, 12, 0, 'work', 'ä»•äº‹');
              PB(12, 0, 13, 0, 'meal', 'é£Ÿäº‹');
              PB(13, 0, 17, 0, 'work', 'ä»•äº‹');
              PB(17, 0, 18, 30, 'study', 'å‹‰å¼·');
              PB(18, 30, 19, 30, 'exercise', 'é‹å‹•');
              PB(19, 30, 21, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(21, 0, 22, 0, 'meal', 'é£Ÿäº‹');
              PB(22, 0, 23, 0, 'rest', 'ä¼‘æ†©');
              PB(23, 0, 24, 0, 'sleep', 'ç¡çœ ');
              break;
            case 2: // å¤œå‹¤æ—¥
              PB(0, 0, 6, 0, 'work', 'ä»•äº‹');
              PB(6, 0, 7, 0, 'move', 'ç§»å‹•');
              PB(7, 0, 14, 30, 'sleep', 'ç¡çœ ');
              PB(14, 30, 15, 30, 'meal', 'é£Ÿäº‹');
              PB(15, 30, 17, 0, 'house', 'å®¶äº‹');
              PB(17, 0, 20, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(20, 0, 21, 0, 'meal', 'é£Ÿäº‹');
              PB(21, 0, 24, 0, 'work', 'ä»•äº‹');
              break;
            case 3: // å­¦ç¿’é›†ä¸­æ—¥
              PB(0, 0, 7, 0, 'sleep', 'ç¡çœ ');
              PB(7, 0, 8, 0, 'house', 'å®¶äº‹');
              PB(8, 0, 9, 0, 'move', 'ç§»å‹•');
              PB(9, 0, 12, 0, 'study', 'å‹‰å¼·');
              PB(12, 0, 13, 0, 'meal', 'é£Ÿäº‹');
              PB(13, 0, 17, 0, 'study', 'å‹‰å¼·');
              PB(17, 0, 18, 0, 'exercise', 'é‹å‹•');
              PB(18, 0, 19, 0, 'move', 'ç§»å‹•');
              PB(19, 0, 20, 0, 'meal', 'é£Ÿäº‹');
              PB(20, 0, 22, 0, 'study', 'å‹‰å¼·');
              PB(22, 0, 24, 0, 'rest', 'ä¼‘æ†©');
              break;
            case 4: // æ—…è¡Œæ—¥
              PB(0, 0, 5, 0, 'sleep', 'ç¡çœ ');
              PB(5, 0, 6, 0, 'house', 'å®¶äº‹');
              PB(6, 0, 12, 0, 'move', 'ç§»å‹•');
              PB(12, 0, 13, 0, 'meal', 'é£Ÿäº‹');
              PB(13, 0, 17, 0, 'move', 'ç§»å‹•');
              PB(17, 0, 18, 0, 'rest', 'ä¼‘æ†©');
              PB(18, 0, 19, 0, 'meal', 'é£Ÿäº‹');
              PB(19, 0, 21, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(21, 0, 24, 0, 'sleep', 'ç¡çœ ');
              break;
            case 5: // å®¶æ—ãƒ»ã‚±ã‚¢æ—¥
              PB(0, 0, 6, 30, 'sleep', 'ç¡çœ ');
              PB(6, 30, 8, 0, 'house', 'å®¶äº‹');
              PB(8, 0, 12, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(12, 0, 13, 0, 'meal', 'é£Ÿäº‹');
              PB(13, 0, 16, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(16, 0, 17, 0, 'move', 'ç§»å‹•');
              PB(17, 0, 18, 0, 'exercise', 'é‹å‹•');
              PB(18, 0, 20, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(20, 0, 21, 0, 'meal', 'é£Ÿäº‹');
              PB(21, 0, 22, 0, 'house', 'å®¶äº‹');
              PB(22, 0, 24, 0, 'rest', 'ä¼‘æ†©');
              break;
            case 6: // å›å¾©ï¼ˆä¼‘é¤Šï¼‰æ—¥
              PB(0, 0, 9, 0, 'sleep', 'ç¡çœ ');
              PB(9, 0, 10, 0, 'meal', 'é£Ÿäº‹');
              PB(10, 0, 12, 0, 'rest', 'ä¼‘æ†©');
              PB(12, 0, 13, 0, 'meal', 'é£Ÿäº‹');
              PB(13, 0, 15, 0, 'rest', 'ä¼‘æ†©');
              PB(15, 0, 16, 0, 'exercise', 'é‹å‹•');
              PB(16, 0, 18, 0, 'rest', 'ä¼‘æ†©');
              PB(18, 0, 19, 0, 'meal', 'é£Ÿäº‹');
              PB(19, 0, 24, 0, 'sleep', 'ç¡çœ ');
              break;
            default:
              return samplePlanForDay(d, 1);
          }
          return acts;
        }
        const container = document.getElementById('monthwrap');
        for (const d of daysInMonth(m)) {
          let j;
          if (useSample) {
            j = { activities: samplePlanForDay(d, sampleId) };
          } else {
            const r = await fetch(`api/day?date=${d}`);
            j = await r.json();
          }
          const row = document.createElement('div');
          row.className = 'dayrow';
          // ãƒ©ãƒ™ãƒ«ï¼‹æŒ‡æ¨™ï¼ˆç¡çœ /ç–²åŠ´/æ°—åˆ†/ãƒ¡ãƒ¢ï¼‰
          const labelWrap = document.createElement('div');
          labelWrap.className = 'daylabel';
          const dateEl = document.createElement('div');
          dateEl.className = 'date';
          dateEl.textContent = d;
          labelWrap.appendChild(dateEl);
          const metricsEl = document.createElement('div');
          metricsEl.className = 'metrics';
          if (!useSample) {
            const mm = Number(j?.sleep_minutes || 0);
            const f = j?.fatigue || {};
            const mmm = j?.mood || {};
            const nt = String(j?.note || '').trim();
            const parts = [];
            if (mm > 0) parts.push(`ç¡${toHM(mm)}`);
            const fSum = (f.morning | 0) + (f.noon | 0) + (f.night | 0);
            if (fSum > 0) parts.push(`ç–²${f.morning | 0}/${f.noon | 0}/${f.night | 0}`);
            const mSum = (mmm.morning | 0) + (mmm.noon | 0) + (mmm.night | 0);
            if (mSum > 0) parts.push(`æ°—${mmm.morning | 0}/${mmm.noon | 0}/${mmm.night | 0}`);
            if (nt.length > 0) parts.push('ğŸ“');
            metricsEl.textContent = parts.join(' ');
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ã«è©³ç´°ã‚‚ä»˜ä¸
            if (parts.length > 0) {
              metricsEl.title = `ç¡çœ :${mm > 0 ? toHM(mm) : '-'} / ç–²åŠ´:${f.morning | 0}/${
                f.noon | 0
              }/${f.night | 0} / æ°—åˆ†:${mmm.morning | 0}/${mmm.noon | 0}/${
                mmm.night | 0
              }${nt ? ' / ãƒ¡ãƒ¢ã‚ã‚Š' : ''}`;
            }
          }
          labelWrap.appendChild(metricsEl);
          row.appendChild(labelWrap);
          const grid = document.createElement('div');
          grid.className = 'grid48';
          const bySlot = new Map((j.activities || []).map((a) => [a.slot, a]));
          for (let i = 0; i < 48; i++) {
            const c = document.createElement('div');
            c.className = 'cell';
            const a = bySlot.get(i);
            const cat = a?.category || 'other';
            c.classList.add('cat-' + cat);
            c.title = String(a?.label || '');
            grid.appendChild(c);
          }
          row.appendChild(grid);
          row.addEventListener('click', () => {
            const u = new URL('./', location.href);
            u.searchParams.set('date', d);
            u.searchParams.set('pal', palette);
            window.open(u.toString(), '_blank');
          });
          container.appendChild(row);
        }
        const SAMPLE_META = {
          1: { t: 'æ¨™æº–å‹¤å‹™æ—¥', d: 'æ—¥å‹¤ãƒ»ç§»å‹•ãƒ»é‹å‹•ãƒ»å®¶æ—ãƒ»é£Ÿäº‹ãŒãƒãƒ©ãƒ³ã‚¹' },
          2: { t: 'å¤œå‹¤æ—¥', d: 'æ·±å¤œï½æ—©æœãŒä»•äº‹ã€æ˜¼é–“ã«ç¡çœ ' },
          3: { t: 'å­¦ç¿’é›†ä¸­æ—¥', d: 'æ—¥ä¸­ã¨å¤œã«å­¦ç¿’ãƒ–ãƒ­ãƒƒã‚¯ãŒé•·ã„' },
          4: { t: 'æ—…è¡Œæ—¥', d: 'ç§»å‹•ãŒé•·æ™‚é–“ã‚’å ã‚ã‚‹' },
          5: { t: 'å®¶æ—ãƒ»ã‚±ã‚¢æ—¥', d: 'å®¶æ—ãƒ»ã‚±ã‚¢ã®å¸¯ãŒä¸»' },
          6: { t: 'å›å¾©ï¼ˆä¼‘é¤Šï¼‰æ—¥', d: 'ç¡çœ ã¨ä¼‘æ†©ãŒå¤šã‚ã€è»½ã„é‹å‹•' },
        };
        const sel = document.getElementById('selSample');
        sel.value = String(sampleId);
        sel.addEventListener('change', () => {
          const u = new URL(location.href);
          u.searchParams.set('sample', sel.value);
          location.href = u.toString();
        });
        const selPal = document.getElementById('selPalette');
        selPal.value = palette;
        function applyPalette(p) {
          document.body.classList.toggle('palette-hc', p === 'hc');
          document.body.classList.toggle('palette-mid', p === 'mid');
          document.body.classList.toggle('palette-pastel', p === 'pastel');
          if (p === 'hc') {
            document.documentElement.style.setProperty('--grid-gap', '2px');
            document.documentElement.style.setProperty('--cell-border', '0');
            document.documentElement.style.setProperty('--cell-radius', '2px');
          } else if (p === 'mid') {
            document.documentElement.style.setProperty('--grid-gap', '2px');
            document.documentElement.style.setProperty('--cell-border', '0');
            document.documentElement.style.setProperty('--cell-radius', '2px');
          } else {
            document.documentElement.style.setProperty('--grid-gap', '1px');
            document.documentElement.style.setProperty('--cell-border', '1px solid #ccc');
            document.documentElement.style.setProperty('--cell-radius', '0');
          }
        }
        applyPalette(palette);
        selPal.addEventListener('change', () => {
          applyPalette(selPal.value);
          localStorage.setItem('dailylog.pal', selPal.value);
          const u = new URL(location.href);
          u.searchParams.set('pal', selPal.value);
          history.replaceState(null, '', u.toString());
        });
        const selH = document.getElementById('selHeight');
        const currentH = getComputedStyle(document.documentElement)
          .getPropertyValue('--cell-h')
          .trim()
          .replace('px', '');
        if (currentH) selH.value = currentH;
        selH.addEventListener('change', () => {
          document.documentElement.style.setProperty('--cell-h', selH.value + 'px');
          localStorage.setItem('dailylog.cell_h', selH.value);
          const u = new URL(location.href);
          u.searchParams.set('h', selH.value);
          history.replaceState(null, '', u.toString());
        });
        if (useSample) {
          const meta = SAMPLE_META[sampleId];
          const palLabel =
            palette === 'hc' ? 'é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ' : palette === 'mid' ? 'ãƒŸãƒ‰ãƒ«' : 'æ·¡è‰²ï¼ˆæ—§é…è‰²ï¼‰';
          document.getElementById('subtitle').textContent =
            `ã‚µãƒ³ãƒ—ãƒ«${sampleId}: ${meta?.t}ï¼ˆ${meta?.d}ï¼‰ï½œé…è‰²: ${palLabel} - DBä¸è¦ã®ãƒ¢ãƒƒã‚¯è¡¨ç¤º`;
        }
        document.getElementById('btnPrint').addEventListener('click', () => window.print());
      })();

      // --- helpers ---
      function toHM(mins) {
        const h = Math.floor(mins / 60);
        const m2 = mins % 60;
        return `${h}:${String(m2).padStart(2, '0')}`;
      }
    </script>
  </body>
</html>
