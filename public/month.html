<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>月次一覧｜生活行動表</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
        --cell-h: 14px;
        --grid-gap: 2px;
        --cell-radius: 2px;
        --cell-border: 0;
        /* 4カラム用の列幅（調整しやすいようにCSS変数化） */
        --col-date: 36px; /* DD 2桁 */
        --col-metrics: 150px;
        --col-note: 220px;
        --row-sep-color: #e5e5e5; /* 行の区切り線（画面） */
      }
      body {
        padding: 8px;
      }
      .head {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .head h2 {
        margin: 6px 0;
      }
      .legend {
        font-size: 12px;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
        margin-left: auto;
      }
      .legend div {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .box {
        width: 10px;
        height: 10px;
        border: 1px solid #333;
      }
      .monthwrap {
        margin-top: 8px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
      }
      /* 列見出し（2カラム: 日付 | 内容） */
      .colhead {
        display: grid;
        grid-template-columns: var(--col-date) 1fr;
        gap: 6px;
        align-items: center;
        font-size: 12px;
        color: #333;
        margin-top: 6px;
        border-bottom: 1px solid var(--row-sep-color, #e5e5e5);
        padding-bottom: 4px;
      }
      .colhead div {
        font-weight: 700;
      }
      /* 時間目盛り（グラフの時間軸） */
      .timescale {
        display: grid;
        grid-template-columns: var(--col-date) 1fr;
        gap: 6px;
        align-items: center;
        color: #666;
        font-size: 11px;
      }
      .timegrid {
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        column-gap: var(--grid-gap);
        height: 16px;
        align-items: end;
        position: relative; /* 24:00 境界線とラベルのため */
      }
      .timegrid .tick {
        position: relative;
        border-left: 1px solid #ddd;
        height: 12px;
      }
      .timegrid .tick.major {
        border-left-color: #aaa;
        height: 14px;
      }
      .timegrid .tick .lab {
        position: absolute;
        bottom: 0;
        transform: translateX(-50%);
        left: 0;
        font-size: 10px;
        white-space: nowrap;
        pointer-events: none;
      }
      .timegrid::after {
        content: '';
        position: absolute;
        right: 0;
        bottom: 0;
        border-left: 1px solid #aaa; /* 24:00 境界線 */
        height: 14px;
      }
      .timegrid .end-label {
        position: absolute;
        right: 0;
        bottom: 0;
        transform: translateX(50%);
        font-size: 11px;
        color: #666;
      }
      .dayrow {
        display: grid;
        /* 2カラム: 日付 | 内容（内容は上下2段: グラフ/メタ） */
        grid-template-columns: var(--col-date) 1fr;
        gap: 6px;
        align-items: center;
        padding: 2px 0;
        border-bottom: 1px solid var(--row-sep-color);
      }
      .monthwrap .dayrow:first-child {
        border-top: 1px solid var(--row-sep-color);
      }
      .daydate {
        display: flex;
        align-items: center;
        justify-content: center;
        height: var(--cell-h);
        line-height: var(--cell-h);
        font-weight: 600;
        font-size: 12px;
        color: #444;
      }
      .daycontent {
        display: grid;
        grid-template-rows: auto auto;
        row-gap: 4px;
        align-items: start;
      }
      .meta {
        display: flex;
        gap: 12px;
        align-items: center;
        min-height: 14px;
      }
      .metrics {
        font-size: 12px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .note {
        font-size: 12px;
        color: #444;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
      }
      .grid48 {
        display: grid;
        /* 48列=30分単位を横一列に展開（折返し無し） */
        grid-template-columns: repeat(48, 1fr);
        gap: var(--grid-gap);
      }
      .cell {
        height: var(--cell-h);
        border: var(--cell-border);
        border-radius: var(--cell-radius);
      }
      .muted {
        color: #666;
        font-size: 12px;
      }
      @media print {
        body {
          padding: 0;
        }
        .noprint {
          display: none;
        }
        .legend,
        .dayrow {
          break-inside: avoid;
          page-break-inside: avoid;
        }
        .metrics,
        .note {
          font-size: 12px; /* 印刷時も視認性を維持 */
        }
        /* 印刷時: 行罫線を強調、背景は無効化 */
        .dayrow {
          background: none !important;
          border-bottom: 0.2mm solid #000;
        }
        .monthwrap .dayrow:first-child {
          border-top: 0.2mm solid #000;
        }
      }
      @media screen {
        /* 画面では薄いゼブラ背景でトラッキングしやすく */
        .dayrow:nth-child(odd) {
          background: #fafafa;
        }
      }
    </style>
  </head>
  <body>
    <div class="head">
      <h2 id="mtitle">月次一覧</h2>
      <div class="legend" id="legend"></div>
      <label class="noprint" style="display: flex; align-items: center; gap: 6px">
        サンプル
        <select id="selSample">
          <option value="0">実データ</option>
          <option value="1">サンプル1: 標準勤務日</option>
          <option value="2">サンプル2: 夜勤日</option>
          <option value="3">サンプル3: 学習集中日</option>
          <option value="4">サンプル4: 旅行日</option>
          <option value="5">サンプル5: 家族・ケア日</option>
          <option value="6">サンプル6: 回復（休養）日</option>
        </select>
      </label>
      <label class="noprint" style="display: flex; align-items: center; gap: 6px">
        配色
        <select id="selPalette">
          <option value="hc">高コントラスト</option>
          <option value="mid" selected>ミドル（標準）</option>
          <option value="pastel">淡色（旧配色）</option>
        </select>
      </label>
      <label class="noprint" style="display: flex; align-items: center; gap: 6px">
        高さ
        <select id="selHeight">
          <option value="10">10px（密）</option>
          <option value="14" selected>14px（標準）</option>
          <option value="18">18px（広）</option>
          <option value="22">22px（特大）</option>
        </select>
      </label>
      <button class="noprint" id="btnPrint">印刷</button>
    </div>
    <div class="muted" id="subtitle">
      各行: 30分×24時間の概況（カテゴリパターン）。クリックで日次ページへ。
    </div>
    <div class="colhead" aria-hidden="false">
      <div>日付</div>
      <div>グラフ／指標・備考</div>
    </div>
    <div class="timescale" aria-hidden="false">
      <div></div>
      <div>
        <div class="timegrid" id="timegrid"></div>
      </div>
    </div>
    <div class="monthwrap" id="monthwrap"></div>
    <script>
      (async function () {
        const q = new URLSearchParams(location.search);
        const m = q.get('month') || new Date().toISOString().slice(0, 7);
        const sampleId = parseInt(q.get('sample') || '0', 10) || 0;
        const palQ = (q.get('pal') || '').toLowerCase();
        const storedPal = localStorage.getItem('dailylog.pal') || '';
        const palette = ['hc', 'mid', 'pastel'].includes(palQ)
          ? palQ
          : ['hc', 'mid', 'pastel'].includes(storedPal)
            ? storedPal
            : 'mid';
        document.body.classList.toggle('palette-hc', palette === 'hc');
        document.body.classList.toggle('palette-mid', palette === 'mid');
        document.body.classList.toggle('palette-pastel', palette === 'pastel');
        const hParam = parseInt(q.get('h') || '', 10);
        const storedH = parseInt(localStorage.getItem('dailylog.cell_h') || '', 10);
        const hPick = !Number.isNaN(hParam) ? hParam : !Number.isNaN(storedH) ? storedH : 14;
        if (hPick >= 8 && hPick <= 28) {
          document.documentElement.style.setProperty('--cell-h', hPick + 'px');
        }
        const useSample = sampleId > 0;
        document.getElementById('mtitle').textContent = `月次一覧 ${m}`;
        const CATS = [
          ['sleep', '睡眠'],
          ['work', '仕事'],
          ['study', '勉強'],
          ['move', '移動'],
          ['meal', '食事'],
          ['exercise', '運動'],
          ['house', '家事'],
          ['family', '家族・ケア'],
          ['rest', '休憩'],
          ['other', 'その他'],
        ];
        const lg = document.getElementById('legend');
        for (const [v, lab] of CATS) {
          const dv = document.createElement('div');
          const bx = document.createElement('span');
          bx.className = 'box cat-' + v;
          dv.appendChild(bx);
          const sp = document.createElement('span');
          sp.textContent = lab;
          dv.appendChild(sp);
          lg.appendChild(dv);
        }
        // 時間目盛り（0..23h, 6時間ごとにラベル）
        const tg = document.getElementById('timegrid');
        if (tg) {
          for (let h = 0; h < 24; h++) {
            const tk = document.createElement('div');
            tk.className = 'tick' + (h % 3 === 0 ? ' major' : '');
            const lab = document.createElement('span');
            lab.className = 'lab';
            lab.textContent = String(h).padStart(2, '0') + ':00';
            tk.appendChild(lab);
            tg.appendChild(tk);
          }
          // 24:00 ラベル（右端）
          const endLab = document.createElement('span');
          endLab.className = 'end-label';
          endLab.textContent = '24:00';
          tg.appendChild(endLab);
        }

        function daysInMonth(ym) {
          const [Y, MM] = ym.split('-').map(Number);
          const last = new Date(Y, MM, 0).getDate();
          const out = [];
          for (let d = 1; d <= last; d++) {
            out.push(`${ym}-${String(d).padStart(2, '0')}`);
          }
          return out;
        }
        function range(a, b) {
          const out = [];
          for (let i = a; i < b; i++) out.push(i);
          return out;
        }
        const slot = (h, m) => h * 2 + (m >= 30 ? 1 : 0);
        function samplePlanForDay(d, sample) {
          const acts = [];
          const push = (start, end, cat, label) => {
            for (let i = start; i < end; i++) {
              acts.push({ slot: i, label, category: cat });
            }
          };
          const PB = (h1, m1, h2, m2, cat, label) => push(slot(h1, m1), slot(h2, m2), cat, label);
          switch (sample) {
            case 1: // 標準勤務日
              PB(0, 0, 6, 30, 'sleep', '睡眠');
              PB(6, 30, 7, 30, 'house', '家事');
              PB(7, 30, 9, 0, 'move', '移動');
              PB(9, 0, 12, 0, 'work', '仕事');
              PB(12, 0, 13, 0, 'meal', '食事');
              PB(13, 0, 17, 0, 'work', '仕事');
              PB(17, 0, 18, 30, 'study', '勉強');
              PB(18, 30, 19, 30, 'exercise', '運動');
              PB(19, 30, 21, 0, 'family', '家族・ケア');
              PB(21, 0, 22, 0, 'meal', '食事');
              PB(22, 0, 23, 0, 'rest', '休憩');
              PB(23, 0, 24, 0, 'sleep', '睡眠');
              break;
            case 2: // 夜勤日
              PB(0, 0, 6, 0, 'work', '仕事');
              PB(6, 0, 7, 0, 'move', '移動');
              PB(7, 0, 14, 30, 'sleep', '睡眠');
              PB(14, 30, 15, 30, 'meal', '食事');
              PB(15, 30, 17, 0, 'house', '家事');
              PB(17, 0, 20, 0, 'family', '家族・ケア');
              PB(20, 0, 21, 0, 'meal', '食事');
              PB(21, 0, 24, 0, 'work', '仕事');
              break;
            case 3: // 学習集中日
              PB(0, 0, 7, 0, 'sleep', '睡眠');
              PB(7, 0, 8, 0, 'house', '家事');
              PB(8, 0, 9, 0, 'move', '移動');
              PB(9, 0, 12, 0, 'study', '勉強');
              PB(12, 0, 13, 0, 'meal', '食事');
              PB(13, 0, 17, 0, 'study', '勉強');
              PB(17, 0, 18, 0, 'exercise', '運動');
              PB(18, 0, 19, 0, 'move', '移動');
              PB(19, 0, 20, 0, 'meal', '食事');
              PB(20, 0, 22, 0, 'study', '勉強');
              PB(22, 0, 24, 0, 'rest', '休憩');
              break;
            case 4: // 旅行日
              PB(0, 0, 5, 0, 'sleep', '睡眠');
              PB(5, 0, 6, 0, 'house', '家事');
              PB(6, 0, 12, 0, 'move', '移動');
              PB(12, 0, 13, 0, 'meal', '食事');
              PB(13, 0, 17, 0, 'move', '移動');
              PB(17, 0, 18, 0, 'rest', '休憩');
              PB(18, 0, 19, 0, 'meal', '食事');
              PB(19, 0, 21, 0, 'family', '家族・ケア');
              PB(21, 0, 24, 0, 'sleep', '睡眠');
              break;
            case 5: // 家族・ケア日
              PB(0, 0, 6, 30, 'sleep', '睡眠');
              PB(6, 30, 8, 0, 'house', '家事');
              PB(8, 0, 12, 0, 'family', '家族・ケア');
              PB(12, 0, 13, 0, 'meal', '食事');
              PB(13, 0, 16, 0, 'family', '家族・ケア');
              PB(16, 0, 17, 0, 'move', '移動');
              PB(17, 0, 18, 0, 'exercise', '運動');
              PB(18, 0, 20, 0, 'family', '家族・ケア');
              PB(20, 0, 21, 0, 'meal', '食事');
              PB(21, 0, 22, 0, 'house', '家事');
              PB(22, 0, 24, 0, 'rest', '休憩');
              break;
            case 6: // 回復（休養）日
              PB(0, 0, 9, 0, 'sleep', '睡眠');
              PB(9, 0, 10, 0, 'meal', '食事');
              PB(10, 0, 12, 0, 'rest', '休憩');
              PB(12, 0, 13, 0, 'meal', '食事');
              PB(13, 0, 15, 0, 'rest', '休憩');
              PB(15, 0, 16, 0, 'exercise', '運動');
              PB(16, 0, 18, 0, 'rest', '休憩');
              PB(18, 0, 19, 0, 'meal', '食事');
              PB(19, 0, 24, 0, 'sleep', '睡眠');
              break;
            default:
              return samplePlanForDay(d, 1);
          }
          return acts;
        }
        function sampleMetricsForDay(d, sample) {
          // サンプル用のダミー指標（概ねパターンに沿った値）
          const dd = Number(d.slice(8, 10));
          const pick = (arr) => arr[(dd - 1) % arr.length];
          switch (sample) {
            case 1: {
              const notes = [
                '在宅: 朝会・1on1',
                '出社: 進捗レビュー',
                '要件定義メモ更新',
                '資料作成: 提案ドラフト',
                '残業1h: リリース準備',
                '出張手配・精算',
                '雑務消化・ヘルプ対応',
              ];
              let note = pick(notes);
              if (dd % 7 === 0)
                note =
                  '長文: 部署横断ミーティング議事要約。決定事項/宿題/期限を整理し関係者へ共有。';
              if (dd % 5 === 0) note = '';
              return {
                sleep_minutes: 6 * 60 + 30,
                fatigue: { morning: 3, noon: 4, night: 5 },
                mood: { morning: 6, noon: 6, night: 7 },
                note,
              };
            }
            case 2: {
              const notes = [
                '夜勤: SV引継ぎ',
                '夜勤明け: 仮眠',
                'アラート多発・復旧',
                '在庫棚卸サポート',
                '夜間対応: 障害テスト',
              ];
              let note = pick(notes);
              if (dd % 6 === 0) note = '体調△: 早め就寝・水分多め';
              return {
                sleep_minutes: 7 * 60 + 30,
                fatigue: { morning: 4, noon: 5, night: 4 },
                mood: { morning: 4, noon: 5, night: 6 },
                note,
              };
            }
            case 3: {
              const notes = [
                'Udemy 2h / 章3',
                'アルゴ練 10問',
                '写経 90m / サンプル実装',
                '英語ドキュメント読解',
                '小課題提出・FB反映',
              ];
              let note = pick(notes);
              if (dd % 8 === 0)
                note = '長文: 学習メモ。抽象化/設計トレードオフ、パフォーマンス測定方法を整理。';
              return {
                sleep_minutes: 7 * 60,
                fatigue: { morning: 2, noon: 3, night: 4 },
                mood: { morning: 6, noon: 7, night: 7 },
                note,
              };
            }
            case 4: {
              const notes = [
                '移動: 東京→大阪',
                '観光: 博物館・市場',
                '渋滞30m: 休憩多め',
                '温泉・早寝',
                '雨: 屋内中心',
              ];
              let note = pick(notes);
              return {
                sleep_minutes: 5 * 60,
                fatigue: { morning: 3, noon: 5, night: 6 },
                mood: { morning: 7, noon: 6, night: 6 },
                note,
              };
            }
            case 5: {
              const notes = [
                '買い出し・作り置き',
                '送迎: 朝/夕',
                '通院付添・処方受取',
                'リハビリ同行メモ',
                '学校行事: 懇談会',
                '看護記録の更新',
                '夜間対応: 2回起床',
              ];
              let note = pick(notes);
              if (dd % 9 === 0)
                note =
                  '長文: ケア計画の見直し案。役割分担、頻度、負担分散について関係者へ相談予定。';
              return {
                sleep_minutes: 6 * 60 + 30,
                fatigue: { morning: 3, noon: 4, night: 4 },
                mood: { morning: 7, noon: 7, night: 6 },
                note,
              };
            }
            case 6: {
              const notes = [
                '安静・水分補給',
                '軽い散歩20m',
                'ストレッチ・温浴',
                '読書・早寝',
                '頭痛△: カフェイン控えめ',
              ];
              let note = pick(notes);
              return {
                sleep_minutes: 9 * 60,
                fatigue: { morning: 1, noon: 2, night: 2 },
                mood: { morning: 5, noon: 6, night: 6 },
                note,
              };
            }
            default:
              return { sleep_minutes: 0, fatigue: {}, mood: {}, note: '' };
          }
        }
        const container = document.getElementById('monthwrap');
        for (const d of daysInMonth(m)) {
          let j;
          if (useSample) {
            j = {
              activities: samplePlanForDay(d, sampleId),
              ...sampleMetricsForDay(d, sampleId),
            };
          } else {
            const r = await fetch(`api/day?date=${d}`);
            j = await r.json();
          }
          const row = document.createElement('div');
          row.className = 'dayrow';
          // 1列目: 日付（DD のみ表示）
          const dateEl = document.createElement('div');
          dateEl.className = 'daydate';
          dateEl.textContent = d.slice(8, 10);
          dateEl.title = d; // フル日付
          row.appendChild(dateEl);
          const content = document.createElement('div');
          content.className = 'daycontent';
          const grid = document.createElement('div');
          grid.className = 'grid48';
          const bySlot = new Map((j.activities || []).map((a) => [a.slot, a]));
          for (let i = 0; i < 48; i++) {
            const c = document.createElement('div');
            c.className = 'cell';
            const a = bySlot.get(i);
            const cat = a?.category || 'other';
            c.classList.add('cat-' + cat);
            c.title = String(a?.label || '');
            grid.appendChild(c);
          }
          content.appendChild(grid);
          // メタ行: 指標 + 備考
          const metricsEl = document.createElement('div');
          metricsEl.className = 'metrics';
          const mm = Number(j?.sleep_minutes || 0);
          const f = j?.fatigue || {};
          const mmm = j?.mood || {};
          const nt = String(j?.note || '').trim();
          const parts = [];
          if (mm > 0) parts.push(`睡${toHM(mm)}`);
          const fSum = (f.morning | 0) + (f.noon | 0) + (f.night | 0);
          if (fSum > 0) parts.push(`疲${f.morning | 0}/${f.noon | 0}/${f.night | 0}`);
          const mSum = (mmm.morning | 0) + (mmm.noon | 0) + (mmm.night | 0);
          if (mSum > 0) parts.push(`気${mmm.morning | 0}/${mmm.noon | 0}/${mmm.night | 0}`);
          if (nt.length > 0) parts.push('📝');
          metricsEl.textContent = parts.join(' ');
          if (parts.length > 0) {
            metricsEl.title = `睡眠:${mm > 0 ? toHM(mm) : '-'} / 疲労:${f.morning | 0}/${
              f.noon | 0
            }/${f.night | 0} / 気分:${mmm.morning | 0}/${mmm.noon | 0}/${
              mmm.night | 0
            }${nt ? ' / メモあり' : ''}`;
          }
          const noteEl = document.createElement('div');
          noteEl.className = 'note';
          noteEl.textContent = nt;
          noteEl.title = nt;
          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.appendChild(metricsEl);
          meta.appendChild(noteEl);
          content.appendChild(meta);
          row.appendChild(content);
          row.addEventListener('click', () => {
            const u = new URL('./', location.href);
            u.searchParams.set('date', d);
            u.searchParams.set('pal', palette);
            window.open(u.toString(), '_blank');
          });
          container.appendChild(row);
        }
        const SAMPLE_META = {
          1: { t: '標準勤務日', d: '日勤・移動・運動・家族・食事がバランス' },
          2: { t: '夜勤日', d: '深夜～早朝が仕事、昼間に睡眠' },
          3: { t: '学習集中日', d: '日中と夜に学習ブロックが長い' },
          4: { t: '旅行日', d: '移動が長時間を占める' },
          5: { t: '家族・ケア日', d: '家族・ケアの帯が主' },
          6: { t: '回復（休養）日', d: '睡眠と休憩が多め、軽い運動' },
        };
        const sel = document.getElementById('selSample');
        sel.value = String(sampleId);
        sel.addEventListener('change', () => {
          const u = new URL(location.href);
          u.searchParams.set('sample', sel.value);
          location.href = u.toString();
        });
        const selPal = document.getElementById('selPalette');
        selPal.value = palette;
        function applyPalette(p) {
          document.body.classList.toggle('palette-hc', p === 'hc');
          document.body.classList.toggle('palette-mid', p === 'mid');
          document.body.classList.toggle('palette-pastel', p === 'pastel');
          if (p === 'hc') {
            document.documentElement.style.setProperty('--grid-gap', '2px');
            document.documentElement.style.setProperty('--cell-border', '0');
            document.documentElement.style.setProperty('--cell-radius', '2px');
          } else if (p === 'mid') {
            document.documentElement.style.setProperty('--grid-gap', '2px');
            document.documentElement.style.setProperty('--cell-border', '0');
            document.documentElement.style.setProperty('--cell-radius', '2px');
          } else {
            document.documentElement.style.setProperty('--grid-gap', '1px');
            document.documentElement.style.setProperty('--cell-border', '1px solid #ccc');
            document.documentElement.style.setProperty('--cell-radius', '0');
          }
        }
        applyPalette(palette);
        selPal.addEventListener('change', () => {
          applyPalette(selPal.value);
          localStorage.setItem('dailylog.pal', selPal.value);
          const u = new URL(location.href);
          u.searchParams.set('pal', selPal.value);
          history.replaceState(null, '', u.toString());
        });
        const selH = document.getElementById('selHeight');
        const currentH = getComputedStyle(document.documentElement)
          .getPropertyValue('--cell-h')
          .trim()
          .replace('px', '');
        if (currentH) selH.value = currentH;
        selH.addEventListener('change', () => {
          document.documentElement.style.setProperty('--cell-h', selH.value + 'px');
          localStorage.setItem('dailylog.cell_h', selH.value);
          const u = new URL(location.href);
          u.searchParams.set('h', selH.value);
          history.replaceState(null, '', u.toString());
        });
        if (useSample) {
          const meta = SAMPLE_META[sampleId];
          const palLabel =
            palette === 'hc' ? '高コントラスト' : palette === 'mid' ? 'ミドル' : '淡色（旧配色）';
          document.getElementById('subtitle').textContent =
            `サンプル${sampleId}: ${meta?.t}（${meta?.d}）｜配色: ${palLabel} - DB不要のモック表示`;
        }
        document.getElementById('btnPrint').addEventListener('click', () => window.print());
      })();

      // --- helpers ---
      function toHM(mins) {
        const h = Math.floor(mins / 60);
        const m2 = mins % 60;
        return `${h}:${String(m2).padStart(2, '0')}`;
      }
    </script>
  </body>
</html>
