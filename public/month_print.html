<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æœˆæ¬¡å°åˆ·ï¼ˆå‰åŠ/å¾ŒåŠï¼‰ï½œç”Ÿæ´»è¡Œå‹•è¡¨</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
        --cell-h: 12px; /* å°åˆ·ã¯å°‘ã—å¯†ã« */
        --grid-gap: 1px;
        --cell-radius: 0;
        --cell-border: 0;
        --col-date: 12mm; /* å°åˆ·æ™‚ã¯mmã§å®‰å®šã•ã›ã‚‹ */
        --col-metrics: 36mm;
        --col-note: 56mm;
        /* å‚™è€ƒã®è¡Œæ•°ï¼ˆ1|2ï¼‰ã€‚note-2 ã‚¯ãƒ©ã‚¹ã§ä¸Šæ›¸ã */
        --note-lines: 1;
      }
      /* developæ¤œè¨¼ç”¨ã®ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºã¯ãƒ˜ãƒƒãƒ€å†…ã®å°ãƒãƒƒã‚¸ã®ã¿ï¼ˆå°åˆ·æ™‚ã¯éè¡¨ç¤ºï¼‰ */
      .debug-badge {
        display: inline-block;
        margin-left: 8px;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: 800;
        color: #fff;
        background: #ff00a8;
        border-radius: 3px;
      }
      :root.note-2 {
        --note-lines: 2;
      }
      body {
        padding: 8px;
      }
      .head {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .head h2 {
        margin: 0;
        font-size: 16px;
      }
      .legend {
        font-size: 11px;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
        margin-left: auto;
      }
      .legend div {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .box {
        width: 10px;
        height: 10px;
        border: 1px solid #333;
      }

      .colhead {
        display: grid;
        grid-template-columns: var(--col-date) 1fr var(--col-metrics) var(--col-note);
        gap: 6px;
        align-items: center;
        font-size: 12px;
        color: #333;
        margin-top: 6px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 3px;
        break-inside: avoid;
      }
      .colhead div {
        font-weight: 700;
      }

      .section {
        page-break-after: always;
        margin-top: 6px;
      }
      .sectitle {
        font-size: 13px;
        color: #333;
        margin: 4px 0;
      }
      .timescale {
        display: grid;
        grid-template-columns: var(--col-date) 1fr var(--col-metrics) var(--col-note);
        gap: 6px;
        align-items: center;
        color: #666;
        font-size: 11px;
      }
      .timegrid {
        position: relative;
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        column-gap: var(--grid-gap);
        height: 16px;
        align-items: end;
      }
      .timegrid .tick {
        position: relative;
        border-left: 1px solid #ddd;
        height: 12px;
      }
      .timegrid .tick.major {
        border-left-color: #aaa;
        height: 14px;
      }
      .timegrid .tick .lab {
        position: absolute;
        bottom: 0;
        transform: translateX(-50%);
        left: 0;
      }
      .timegrid::after {
        content: '';
        position: absolute;
        right: 0;
        bottom: 0;
        border-left: 1px solid #aaa;
        height: 14px;
      }
      .timegrid .end-label {
        position: absolute;
        right: 0;
        bottom: 0;
        transform: translateX(50%);
        font-size: 11px;
        color: #666;
      }

      .rows {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2px;
      }
      .dayrow {
        display: grid;
        grid-template-columns: var(--col-date) 1fr var(--col-metrics) var(--col-note);
        gap: 6px;
        align-items: start;
        border-bottom: 0.2mm solid #000;
        padding: 1px 0;
        break-inside: avoid; /* è¡Œåˆ†å‰²é˜²æ­¢ */
        page-break-inside: avoid;
      }
      .rows .dayrow:first-child {
        border-top: 0.2mm solid #000;
      }
      .daydate {
        display: flex;
        align-items: center;
        justify-content: center;
        height: var(--cell-h);
        line-height: var(--cell-h);
        font-weight: 700;
        font-size: 12px;
      }
      .grid48 {
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        gap: var(--grid-gap);
      }
      .cell {
        height: var(--cell-h);
        border: var(--cell-border);
        border-radius: var(--cell-radius);
      }
      .metrics {
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .note {
        font-size: 12px;
        color: #444;
        overflow: visible; /* â† çœç•¥è¨˜å·é€£é–ã‚’æ–­ã¤ */
        display: block;
        min-width: 0; /* Gridå†…ã§æŠ˜è¿”ã—å¯èƒ½ã« */
      }
      /* ç”»é¢/å°åˆ·å…±é€šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ1è¡Œï¼‰: innerã‚’1è¡Œã«è¦‹ã›ã‚‹ */
      .note .note-inner {
        display: block;
        line-height: 1.2;
        max-height: 1.2em; /* æ—¢å®š1è¡Œ */
        overflow: hidden;
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal;
        text-overflow: clip;
      }

      @page {
        size: A4 landscape;
        margin: 8mm;
      }
      @media print {
        /* ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºã¯å°åˆ·ã«ã¯å‡ºã•ãªã„ */
        #debug-banner {
          display: none !important;
        }
        /* ãƒ‡ãƒãƒƒã‚°ãƒãƒƒã‚¸ã‚‚å°åˆ·ã«ã¯å‡ºã•ãªã„ */
        .debug-badge {
          display: none !important;
        }
        /* å°åˆ·æ™‚ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§å®‰å®šåŒ– */
        .rows {
          display: table;
          width: 100%;
          table-layout: fixed;
          border-collapse: separate;
          border-spacing: 0 2px; /* è¡Œé–“ã‚’ç¶­æŒ */
        }
        .dayrow {
          display: table-row;
          page-break-inside: avoid;
        }
        .daydate,
        .graph,
        .metrics,
        .note {
          display: table-cell;
          vertical-align: top;
        }
        .daydate {
          width: var(--col-date);
        }
        .metrics {
          width: var(--col-metrics);
        }
        .note {
          width: var(--col-note);
        }

        /* è¤‡æ•°è¡ŒæŠ˜è¿”ã—ã‚’ç¢ºå®Ÿã« */
        .rows .dayrow .note {
          white-space: normal !important;
          text-overflow: clip !important;
          min-width: 0;
        }
        .rows .dayrow .note .note-inner {
          line-height: 1.2 !important;
          /* Chromeå°åˆ·å¯¾ç­–: WebKitç³»ã®2è¡Œã‚¯ãƒ©ãƒ³ãƒ—ã‚’åˆ©ç”¨ */
          display: -webkit-box !important;
          -webkit-box-orient: vertical !important;
          -webkit-line-clamp: var(--note-lines) !important; /* 1 or 2 */
          overflow: hidden !important;
          overflow-wrap: anywhere !important;
          word-break: break-word !important;
          white-space: normal !important;
        }
        .noprint {
          display: none;
        }
        * {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
      }
    </style>
  </head>
  <body>
    <div class="head noprint">
      <h2>æœˆæ¬¡å°åˆ·ï¼ˆå‰åŠ/å¾ŒåŠï¼‰</h2>
      <div class="legend" id="legend"></div>
      <label style="display: flex; align-items: center; gap: 6px">
        ã‚µãƒ³ãƒ—ãƒ«
        <select id="selSample">
          <option value="0">å®Ÿãƒ‡ãƒ¼ã‚¿</option>
          <option value="1">ã‚µãƒ³ãƒ—ãƒ«1: æ¨™æº–å‹¤å‹™æ—¥</option>
          <option value="2">ã‚µãƒ³ãƒ—ãƒ«2: å¤œå‹¤æ—¥</option>
          <option value="3">ã‚µãƒ³ãƒ—ãƒ«3: å­¦ç¿’é›†ä¸­æ—¥</option>
          <option value="4">ã‚µãƒ³ãƒ—ãƒ«4: æ—…è¡Œæ—¥</option>
          <option value="5" selected>ã‚µãƒ³ãƒ—ãƒ«5: å®¶æ—ãƒ»ã‚±ã‚¢æ—¥</option>
          <option value="6">ã‚µãƒ³ãƒ—ãƒ«6: å›å¾©ï¼ˆä¼‘é¤Šï¼‰æ—¥</option>
        </select>
      </label>
      <label style="display: flex; align-items: center; gap: 6px">
        å‚™è€ƒ2è¡Œ
        <input type="checkbox" id="chkNote2" />
      </label>
      <button id="btnPrint">å°åˆ·</button>
      <label style="display: flex; align-items: center; gap: 6px" class="noprint">
        Debug
        <input type="checkbox" id="chkDebug" />
      </label>
    </div>

    <div id="container"></div>

    <script>
      (async function () {
        const q = new URLSearchParams(location.search);
        const m = q.get('month') || new Date().toISOString().slice(0, 7);
        const sampleId = parseInt(q.get('sample') || '5', 10) || 0;
        document.title = `æœˆæ¬¡å°åˆ· ${m}`;

        const lg = document.getElementById('legend');
        const CATS = [
          ['sleep', 'ç¡çœ '],
          ['work', 'ä»•äº‹'],
          ['study', 'å‹‰å¼·'],
          ['move', 'ç§»å‹•'],
          ['meal', 'é£Ÿäº‹'],
          ['exercise', 'é‹å‹•'],
          ['house', 'å®¶äº‹'],
          ['family', 'å®¶æ—ãƒ»ã‚±ã‚¢'],
          ['rest', 'ä¼‘æ†©'],
          ['other', 'ãã®ä»–'],
        ];
        for (const [v, lab] of CATS) {
          const dv = document.createElement('div');
          const bx = document.createElement('span');
          bx.className = 'box cat-' + v;
          dv.appendChild(bx);
          const sp = document.createElement('span');
          sp.textContent = lab;
          dv.appendChild(sp);
          lg.appendChild(dv);
        }

        function daysInMonth(ym) {
          const [Y, MM] = ym.split('-').map(Number);
          const last = new Date(Y, MM, 0).getDate();
          const out = [];
          for (let d = 1; d <= last; d++) out.push(`${ym}-${String(d).padStart(2, '0')}`);
          return out;
        }
        const slot = (h, m) => h * 2 + (m >= 30 ? 1 : 0);
        function samplePlanForDay(d, sample) {
          const acts = [];
          const push = (start, end, cat, label) => {
            for (let i = start; i < end; i++) acts.push({ slot: i, label, category: cat });
          };
          const PB = (h1, m1, h2, m2, cat, label) => push(slot(h1, m1), slot(h2, m2), cat, label);
          switch (sample) {
            case 5:
              PB(0, 0, 6, 30, 'sleep', 'ç¡çœ ');
              PB(6, 30, 8, 0, 'house', 'å®¶äº‹');
              PB(8, 0, 12, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(12, 0, 13, 0, 'meal', 'é£Ÿäº‹');
              PB(13, 0, 16, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(16, 0, 17, 0, 'move', 'ç§»å‹•');
              PB(17, 0, 18, 0, 'exercise', 'é‹å‹•');
              PB(18, 0, 20, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(20, 0, 21, 0, 'meal', 'é£Ÿäº‹');
              PB(21, 0, 22, 0, 'house', 'å®¶äº‹');
              PB(22, 0, 24, 0, 'rest', 'ä¼‘æ†©');
              break;
            default:
              PB(0, 0, 7, 0, 'sleep', 'ç¡çœ ');
              PB(7, 0, 8, 0, 'house', 'å®¶äº‹');
              PB(8, 0, 9, 0, 'move', 'ç§»å‹•');
              PB(9, 0, 12, 0, 'work', 'ä»•äº‹');
              PB(12, 0, 13, 0, 'meal', 'é£Ÿäº‹');
              PB(13, 0, 17, 0, 'work', 'ä»•äº‹');
              PB(17, 0, 18, 30, 'study', 'å‹‰å¼·');
              PB(18, 30, 19, 30, 'exercise', 'é‹å‹•');
              PB(19, 30, 21, 0, 'family', 'å®¶æ—ãƒ»ã‚±ã‚¢');
              PB(21, 0, 22, 0, 'meal', 'é£Ÿäº‹');
              PB(22, 0, 24, 0, 'sleep', 'ç¡çœ ');
          }
          return acts;
        }
        function sampleMetricsForDay(d) {
          const dd = Number(d.slice(8, 10));
          const notes = [
            'è²·ã„å‡ºã—ãƒ»ä½œã‚Šç½®ã',
            'é€è¿: æœ/å¤•',
            'é€šé™¢ä»˜æ·»ãƒ»å‡¦æ–¹å—å–',
            'ãƒªãƒãƒ“ãƒªåŒè¡Œãƒ¡ãƒ¢',
            'å­¦æ ¡è¡Œäº‹: æ‡‡è«‡ä¼š',
            'çœ‹è­·è¨˜éŒ²ã®æ›´æ–°',
            'å¤œé–“å¯¾å¿œ: 2å›èµ·åºŠ',
          ];
          let note = notes[(dd - 1) % notes.length];
          if (dd % 9 === 0)
            note = 'é•·æ–‡: ã‚±ã‚¢è¨ˆç”»ã®è¦‹ç›´ã—æ¡ˆã€‚å½¹å‰²åˆ†æ‹…ã€é »åº¦ã€è² æ‹…åˆ†æ•£ã«ã¤ã„ã¦é–¢ä¿‚è€…ã¸ç›¸è«‡äºˆå®šã€‚';
          return {
            sleep_minutes: 6 * 60 + 30,
            fatigue: { morning: 3, noon: 4, night: 4 },
            mood: { morning: 7, noon: 7, night: 6 },
            note,
          };
        }
        function toHM(mins) {
          const h = Math.floor(mins / 60);
          const m2 = mins % 60;
          return `${h}:${String(m2).padStart(2, '0')}`;
        }

        function buildTimeGrid(el) {
          for (let h = 0; h < 24; h++) {
            const tk = document.createElement('div');
            tk.className = 'tick' + (h % 6 === 0 ? ' major' : '');
            if (h % 6 === 0) {
              const lab = document.createElement('span');
              lab.className = 'lab';
              lab.textContent = String(h).padStart(2, '0') + ':00';
              tk.appendChild(lab);
            }
            el.appendChild(tk);
          }
          const endLab = document.createElement('span');
          endLab.className = 'end-label';
          endLab.textContent = '24:00';
          el.appendChild(endLab);
        }

        async function buildSection(title, days) {
          const sec = document.createElement('section');
          sec.className = 'section';
          const h = document.createElement('div');
          h.className = 'sectitle';
          h.textContent = `${title} ${m}`;
          sec.appendChild(h);
          const ch = document.createElement('div');
          ch.className = 'colhead';
          ch.innerHTML =
            '<div>æ—¥ä»˜</div><div>ã‚°ãƒ©ãƒ•ï¼ˆ0:00â†’24:00ï¼‰</div><div>æŒ‡æ¨™</div><div>å‚™è€ƒ</div>';
          sec.appendChild(ch);
          const ts = document.createElement('div');
          ts.className = 'timescale';
          ts.innerHTML = '<div></div><div><div class="timegrid"></div></div><div></div><div></div>';
          sec.appendChild(ts);
          buildTimeGrid(ts.querySelector('.timegrid'));
          const rows = document.createElement('div');
          rows.className = 'rows';
          sec.appendChild(rows);
          for (const d of days) {
            let j;
            if (sampleId > 0)
              j = { activities: samplePlanForDay(d, sampleId), ...sampleMetricsForDay(d) };
            else {
              const r = await fetch(`api/day?date=${d}`);
              j = await r.json();
            }
            const row = document.createElement('div');
            row.className = 'dayrow';
            const dateEl = document.createElement('div');
            dateEl.className = 'daydate';
            dateEl.textContent = d.slice(8, 10);
            dateEl.title = d;
            row.appendChild(dateEl);
            const grid = document.createElement('div');
            grid.className = 'grid48';
            const bySlot = new Map((j.activities || []).map((a) => [a.slot, a]));
            for (let i = 0; i < 48; i++) {
              const c = document.createElement('div');
              c.className = 'cell';
              const a = bySlot.get(i);
              const cat = a?.category || 'other';
              c.classList.add('cat-' + cat);
              c.title = String(a?.label || '');
              grid.appendChild(c);
            }
            const graphCell = document.createElement('div');
            graphCell.className = 'graph';
            graphCell.appendChild(grid);
            row.appendChild(graphCell);
            const mm = Number(j?.sleep_minutes || 0);
            const f = j?.fatigue || {};
            const mmm = j?.mood || {};
            let nt = String(j?.note || '').trim();
            // ãƒ‡ãƒ¢ç”¨: å¼·åˆ¶çš„ã«é•·æ–‡ã«ã—ã¦2è¡Œè¡¨ç¤ºã‚’ç¢ºèª
            const forceTwo = (q.get('demo_note2') || '') === '1';
            if (forceTwo) {
              const base = nt || 'é•·æ–‡: ãƒ‡ãƒ¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã€‚æŠ˜è¿”ã—ã¨2è¡Œè¡¨ç¤ºã®ç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚';
              nt = base + 'ï½œã‚±ã‚¢è¨ˆç”»ã®è¦‹ç›´ã—ãƒ»å½¹å‰²åˆ†æ‹…ãƒ»é »åº¦ãƒ»è² æ‹…åˆ†æ•£ã«ã¤ã„ã¦é–¢ä¿‚è€…ã¸å…±æœ‰äºˆå®šã€‚';
            }
            const parts = [];
            if (mm > 0) parts.push(`ç¡${toHM(mm)}`);
            const fSum = (f.morning | 0) + (f.noon | 0) + (f.night | 0);
            if (fSum > 0) parts.push(`ç–²${f.morning | 0}/${f.noon | 0}/${f.night | 0}`);
            const mSum = (mmm.morning | 0) + (mmm.noon | 0) + (mmm.night | 0);
            if (mSum > 0) parts.push(`æ°—${mmm.morning | 0}/${mmm.noon | 0}/${mmm.night | 0}`);
            if (nt.length > 0) parts.push('ğŸ“');
            const metricsEl = document.createElement('div');
            metricsEl.className = 'metrics';
            metricsEl.textContent = parts.join(' ');
            metricsEl.title = parts.length
              ? `ç¡çœ :${mm > 0 ? toHM(mm) : '-'} / ç–²åŠ´:${f.morning | 0}/${f.noon | 0}/${f.night | 0} / æ°—åˆ†:${mmm.morning | 0}/${mmm.noon | 0}/${mmm.night | 0}${nt ? ' / ãƒ¡ãƒ¢ã‚ã‚Š' : ''}`
              : '';
            row.appendChild(metricsEl);
            const noteEl = document.createElement('div');
            noteEl.className = 'note';
            noteEl.title = nt;
            const span = document.createElement('span');
            span.className = 'note-inner';
            span.textContent = nt;
            noteEl.appendChild(span);
            row.appendChild(noteEl);
            rows.appendChild(row);
          }
          return sec;
        }

        const allDays = daysInMonth(m);
        const first = allDays.slice(0, 15);
        const second = allDays.slice(15);
        const container = document.getElementById('container');
        container.appendChild(await buildSection('å‰åŠ', first));
        container.appendChild(await buildSection('å¾ŒåŠ', second));

        document.getElementById('btnPrint')?.addEventListener('click', () => window.print());
        const sel = document.getElementById('selSample');
        if (sel) {
          sel.value = String(sampleId);
          sel.addEventListener('change', () => {
            const u = new URL(location.href);
            u.searchParams.set('sample', sel.value);
            location.href = u.toString();
          });
        }

        // å‚™è€ƒ2è¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const linesParam = Math.max(1, Math.min(2, parseInt(q.get('note_lines') || '1', 10) || 1));
        document.documentElement.classList.toggle('note-2', linesParam === 2);
        const chk2 = document.getElementById('chkNote2');
        if (chk2) {
          chk2.checked = linesParam === 2;
          chk2.addEventListener('change', () => {
            const u = new URL(location.href);
            u.searchParams.set('note_lines', chk2.checked ? '2' : '1');
            location.href = u.toString();
          });
        }

        // Debugãƒãƒƒã‚¸ã®è¡¨ç¤ºåˆ‡æ›¿
        const dbg = (q.get('debug') || '0') === '1';
        const chkDbg = document.getElementById('chkDebug');
        if (chkDbg) chkDbg.checked = dbg;
        function applyDebug(on) {
          // ãƒ˜ãƒƒãƒ€å†…ã«å°ã•ãªãƒãƒƒã‚¸ã®ã¿ã‚’è¡¨ç¤ºï¼ˆå°åˆ·æ™‚ã¯éè¡¨ç¤ºï¼‰
          const head = document.querySelector('.head');
          if (!head) return;
          const id = 'debug-badge';
          head.querySelector('#' + id)?.remove();
          if (on) {
            const s = document.createElement('span');
            s.className = 'debug-badge';
            s.id = id;
            s.textContent = 'DEBUG';
            head.appendChild(s);
          }
        }
        applyDebug(dbg);
        if (chkDbg)
          chkDbg.addEventListener('change', () => {
            const u = new URL(location.href);
            u.searchParams.set('debug', chkDbg.checked ? '1' : '0');
            location.href = u.toString();
          });
      })();
    </script>
  </body>
</html>
