<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>生活行動表（日次）</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>生活行動表（日次）</h1>
      <div class="controls no-print">
        <label>日付 <input type="date" id="date" /></label>
        <span id="weekday" class="muted"></span>
        <button id="btnToday">今日</button>
        <button id="btnLoad">読込</button>
        <button id="btnSave">保存</button>
        <button id="btnSleep">睡眠自動集計</button>
        <button id="btnMonthly">月次ページ</button>
        <button id="btnPrint">印刷（日次）</button>
      </div>
    </header>

    <section class="grid">
      <div class="panel">
        <h2>30分ごとの行動</h2>
        <div class="slot-grid">
          <div class="slot-col">
            <div class="slot-col-header">AM（午前）</div>
            <table class="slots subtable" id="tableLeft">
              <thead>
                <tr>
                  <th>時刻</th>
                  <th>区分</th>
                  <th>内容</th>
                </tr>
              </thead>
              <tbody id="slotBodyL"></tbody>
            </table>
          </div>
          <div class="slot-col">
            <div class="slot-col-header">PM（午後）</div>
            <table class="slots subtable" id="tableRight">
              <thead>
                <tr>
                  <th>時刻</th>
                  <th>区分</th>
                  <th>内容</th>
                </tr>
              </thead>
              <tbody id="slotBodyR"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>指標</h2>
        <div class="metrics">
          <div class="metric">
            <label>合計睡眠時間（分）<input type="number" id="sleep" min="0" step="30" /></label>
          </div>
          <div class="metric">
            <h3>疲労度（1-10）</h3>
            <label
              >朝 <input type="range" id="fat_m" min="1" max="10" value="5" /><output id="fat_m_o"
                >5</output
              ></label
            >
            <label
              >午後 <input type="range" id="fat_n" min="1" max="10" value="5" /><output id="fat_n_o"
                >5</output
              ></label
            >
            <label
              >夜 <input type="range" id="fat_e" min="1" max="10" value="5" /><output id="fat_e_o"
                >5</output
              ></label
            >
          </div>
          <div class="metric">
            <h3>
              気分指数（1-10） <small class="muted">1–3:わるい / 4–7:ふつう / 8–10:よい</small>
            </h3>
            <label
              >朝 <input type="range" id="mood_m" min="1" max="10" value="5" /><output id="mood_m_o"
                >5</output
              >
              <span class="badge" id="mood_m_b"></span
            ></label>
            <label
              >午後 <input type="range" id="mood_n" min="1" max="10" value="5" /><output
                id="mood_n_o"
                >5</output
              >
              <span class="badge" id="mood_n_b"></span
            ></label>
            <label
              >夜 <input type="range" id="mood_e" min="1" max="10" value="5" /><output id="mood_e_o"
                >5</output
              >
              <span class="badge" id="mood_e_b"></span
            ></label>
          </div>
          <div class="metric">
            <h3>備考</h3>
            <textarea id="note" rows="6" placeholder="メモ…"></textarea>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <small class="muted">© DailyLog</small>
    </footer>

    <script>
      (function () {
        // 配色パレットの適用（URL > localStorage > 既定: mid）
        try {
          const q = new URLSearchParams(location.search);
          const palQ = (q.get('pal') || '').toLowerCase();
          const stPal = localStorage.getItem('dailylog.pal') || '';
          const palette = ['hc','mid','pastel'].includes(palQ) ? palQ : (['hc','mid','pastel'].includes(stPal) ? stPal : 'mid');
          document.body.classList.toggle('palette-hc', palette === 'hc');
          document.body.classList.toggle('palette-mid', palette === 'mid');
          document.body.classList.toggle('palette-pastel', palette === 'pastel');
        } catch (_) {}
        const dateEl = document.getElementById('date');
        const weekdayEl = document.getElementById('weekday');
        const slotBodyL = document.getElementById('slotBodyL');
        const slotBodyR = document.getElementById('slotBodyR');
        const sleepEl = document.getElementById('sleep');
        const fatEls = { m: id('fat_m'), n: id('fat_n'), e: id('fat_e') };
        const moodEls = { m: id('mood_m'), n: id('mood_n'), e: id('mood_e') };
        const fatOut = { m: id('fat_m_o'), n: id('fat_n_o'), e: id('fat_e_o') };
        const moodOut = { m: id('mood_m_o'), n: id('mood_n_o'), e: id('mood_n_o') };
        const moodBadge = { m: id('mood_m_b'), n: id('mood_n_b'), e: id('mood_e_b') };
        const noteEl = document.getElementById('note');

        function id(x) {
          return document.getElementById(x);
        }
        function fmt(i) {
          const h = Math.floor(i / 2)
            .toString()
            .padStart(2, '0');
          const m = i % 2 ? '30' : '00';
          const hn = Math.floor((i + 1) / 2)
            .toString()
            .padStart(2, '0');
          const mn = (i + 1) % 2 ? '30' : '00';
          return `${h}:${m}–${hn}:${mn}`;
        }
        function jaW(d) {
          return new Intl.DateTimeFormat('ja-JP', { weekday: 'short' }).format(
            new Date(d + 'T00:00:00')
          );
        }
        function moodLabel(v) {
          return v >= 8 ? 'よい' : v >= 4 ? 'ふつう' : 'わるい';
        }

        // Build 48 rows (24×2 列) with category select + detail
        const detailInputs = [];
        const catSelects = [];
        const CATS = [
          ['sleep', '睡眠'],
          ['work', '仕事'],
          ['study', '勉強'],
          ['move', '移動'],
          ['meal', '食事'],
          ['exercise', '運動'],
          ['house', '家事'],
          ['family', '家族・ケア'],
          ['rest', '休憩'],
          ['other', 'その他'],
        ];
        function buildRow(i) {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td');
          td1.textContent = fmt(i);
          const td2 = document.createElement('td');
          const sel = document.createElement('select');
          sel.dataset.slot = i;
          sel.tabIndex = i + 1;
          for (const [v, lab] of CATS) {
            const o = document.createElement('option');
            o.value = v;
            o.textContent = lab;
            sel.appendChild(o);
          }
          td2.appendChild(sel);
          const td3 = document.createElement('td');
          const inp = document.createElement('input');
          inp.type = 'text';
          inp.size = 40;
          inp.placeholder = '作業 / 移動 / 睡眠';
          inp.dataset.slot = i;
          td3.appendChild(inp);
          tr.appendChild(td1);
          tr.appendChild(td2);
          tr.appendChild(td3);
          detailInputs[i] = inp;
          catSelects[i] = sel;
          sel.addEventListener('change', () => {
            tr.className = 'cat-' + (sel.value || 'other');
          });
          return tr;
        }
        for (let i = 0; i < 24; i++) {
          slotBodyL.appendChild(buildRow(i));
        }
        for (let i = 24; i < 48; i++) {
          slotBodyR.appendChild(buildRow(i));
        }

        function syncMoodUI() {
          for (const k of ['m', 'n', 'e']) {
            fatOut[k].value = fatEls[k].value;
          }
          const map = { m: 'mood_m', n: 'mood_n', e: 'mood_e' };
          const out = { m: 'mood_m_o', n: 'mood_n_o', e: 'mood_e_o' };
          for (const k of ['m', 'n', 'e']) {
            id(out[k]).value = id(map[k]).value;
            moodBadge[k].textContent = moodLabel(parseInt(id(map[k]).value || '0', 10));
          }
        }
        ['m', 'n', 'e'].forEach((k) => {
          moodEls[k].addEventListener('input', syncMoodUI);
        });
        ['m', 'n', 'e'].forEach((k) => {
          fatEls[k].addEventListener('input', syncMoodUI);
        });

        function today() {
          const d = new Date();
          const ds = d.toISOString().slice(0, 10);
          dateEl.value = ds;
          weekdayEl.textContent = `（${jaW(ds)}）`;
        }
        dateEl.addEventListener('change', () => {
          weekdayEl.textContent = `（${jaW(dateEl.value)}）`;
        });

        async function load() {
          if (!/^\d{4}-\d{2}-\d{2}$/.test(dateEl.value)) return alert('日付が未指定');
          const r = await fetch(`api/day?date=${dateEl.value}`);
          const j = await r.json();
          detailInputs.forEach((inp, idx) => {
            if (inp) {
              inp.value = '';
              const sel = catSelects[idx];
              if (sel) {
                sel.value = 'other';
                sel.dispatchEvent(new Event('change'));
              }
            }
          });
          (j.activities || []).forEach((a) => {
            if (detailInputs[a.slot]) detailInputs[a.slot].value = a.label || '';
            if (catSelects[a.slot]) {
              catSelects[a.slot].value = a.category || 'other';
              catSelects[a.slot].dispatchEvent(new Event('change'));
            }
          });
          sleepEl.value = j.sleep_minutes || 0;
          fatEls.m.value = j.fatigue?.morning || 0;
          fatEls.n.value = j.fatigue?.noon || 0;
          fatEls.e.value = j.fatigue?.night || 0;
          moodEls.m.value = j.mood?.morning || 0;
          moodEls.n.value = j.mood?.noon || 0;
          moodEls.e.value = j.mood?.night || 0;
          noteEl.value = j.note || '';
          syncMoodUI();
        }

        async function save() {
          const payload = {
            date: dateEl.value,
            sleep_minutes: parseInt(sleepEl.value || '0', 10),
            fatigue: { morning: +fatEls.m.value, noon: +fatEls.n.value, night: +fatEls.e.value },
            mood: { morning: +moodEls.m.value, noon: +moodEls.n.value, night: +moodEls.e.value },
            note: noteEl.value,
            activities: detailInputs
              .map((inp, i) => ({
                slot: i,
                label: inp.value.trim(),
                category: catSelects[i]?.value || 'other',
              }))
              .filter((x) => x.label !== ''),
          };
          const r = await fetch('api/day', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const j = await r.json();
          if (j.ok) alert('保存しました');
          else alert('保存に失敗');
        }

        function autoSleep() {
          const minutes = inputs.reduce(
            (acc, inp) => acc + (/^\s*睡眠\s*$/i.test(inp.value) ? 30 : 0),
            0
          );
          sleepEl.value = minutes;
        }

        // Buttons
        id('btnToday').addEventListener('click', () => {
          today();
          load();
          setTimeout(() => {
            const t = inputs.find((x) => !x.value);
            t?.focus();
          }, 0);
        });
        id('btnLoad').addEventListener('click', load);
        id('btnSave').addEventListener('click', save);
        id('btnSleep').addEventListener('click', autoSleep);
        id('btnMonthly').addEventListener('click', () => {
          const d = document.getElementById('date').value;
          const m = /^\d{4}-\d{2}-\d{2}$/.test(d)
            ? d.slice(0, 7)
            : new Date().toISOString().slice(0, 7);
          window.open(`month.html?month=${m}`, '_blank');
        });
        id('btnPrint').addEventListener('click', () => {
          const d = document.getElementById('date').value;
          const q = /^\d{4}-\d{2}-\d{2}$/.test(d) ? `?date=${d}` : '';
          window.open(`print.html${q}`, '_blank');
        });

        // init
        today();
        syncMoodUI();
        load();
      })();
    </script>
  </body>
</html>
